# Place this file in SeaMeet-Releases repo at:
# .github/workflows/sync-back-to-app.yml
#
# Required secret in SeaMeet-Releases repo settings:
#   SEAMEET_APP_TOKEN — fine-grained PAT with access to seameet-app-desktop
#   Permissions needed: Contents (Read & Write), Pull Requests (Read & Write)

name: Sync i18n back to seameet-app-desktop

on:
  push:
    branches:
      - main
    paths:
      - 'i18n/**'

jobs:
  sync-back:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout SeaMeet-Releases
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Checkout seameet-app-desktop
        uses: actions/checkout@v4
        with:
          repository: seasalt-ai/seameet-app-desktop
          token: ${{ secrets.SEAMEET_APP_TOKEN }}
          path: seameet-app-desktop

      - name: Detect changed i18n files
        id: changed
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'i18n/*.json' 'i18n/terminology/*.json' | tr '\n' ' ')
          else
            CHANGED=$(git diff --name-only "$BEFORE" "$AFTER" -- 'i18n/*.json' 'i18n/terminology/*.json' | tr '\n' ' ')
          fi
          echo "files=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "Changed files: $CHANGED"

      - name: Copy changed files to seameet-app-desktop
        run: |
          for f in i18n/*.json; do
            fname=$(basename "$f")
            if [ "$fname" != "README.md" ]; then
              cp "$f" "seameet-app-desktop/src/i18n/$fname"
            fi
          done
          if [ -d i18n/terminology ]; then
            for f in i18n/terminology/terminology*.json; do
              fname=$(basename "$f")
              cp "$f" "seameet-app-desktop/.jta/$fname"
            done
          fi

      - name: Create PR in seameet-app-desktop
        env:
          GH_TOKEN: ${{ secrets.SEAMEET_APP_TOKEN }}
          RELEASES_SHA: ${{ github.sha }}
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          cd seameet-app-desktop

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          SHORT_SHA=$(echo "$RELEASES_SHA" | cut -c1-7)
          BRANCH="i18n-sync/$SHORT_SHA"

          git checkout -b "$BRANCH"
          git add src/i18n/ .jta/

          if git diff --staged --quiet; then
            echo "No changes to sync back — files are already up to date."
            exit 0
          fi

          git commit -m "i18n: sync community translations from SeaMeet-Releases@$SHORT_SHA"
          git push origin "$BRANCH"

          printf '%s\n' \
            '## Community Translation Sync' \
            '' \
            'This PR was automatically created by the SeaMeet-Releases sync-back workflow.' \
            '' \
            "**Source:** [SeaMeet-Releases@$RELEASES_SHA](https://github.com/seameet-ai/SeaMeet-Releases/commit/$RELEASES_SHA)" \
            '' \
            "**Changed files:** $CHANGED_FILES" \
            '' \
            '### Review checklist' \
            '- [ ] Check that placeholder variables (double-brace tokens) are intact in changed locale files' \
            '- [ ] Run `npm run i18n:validate` locally to confirm no integrity failures' \
            '- [ ] Merge when satisfied' \
            '' \
            'The CI `i18n-check` workflow will run automatically on this PR.' \
            > /tmp/pr-body.md

          gh pr create \
            --repo seasalt-ai/seameet-app-desktop \
            --base main \
            --head "$BRANCH" \
            --title "i18n: sync community translations from SeaMeet-Releases@$SHORT_SHA" \
            --body-file /tmp/pr-body.md
